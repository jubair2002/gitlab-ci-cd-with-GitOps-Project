.user_service: &user_service_rules
  rules:
    - changes:
        - user-service/**/*
      when: always
    - when: never

stages:
  - build
  - push
  - update-manifest

variables:
  SERVICE_NAME: user-service
  IMAGES_NAME: jubair2002/user-service
  IMAGE_TAG: $CI_COMMIT_SHA

build_user_service:
  stage: build
  <<: *user_service_rules
  script:
    - echo "Building $SERVICE_NAME Docker image..."
    - docker build -t $IMAGES_NAME:$IMAGE_TAG user-service

push_user_service:
  stage: push
  <<: *user_service_rules
  script:
    - echo "Pushing $SERVICE_NAME Docker image to registry....."
    - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
    - docker push $IMAGES_NAME:$IMAGE_TAG

update-user-manifest:
  stage: update-manifest
  <<: *user_service_rules
  script:
    - echo "Updating manifest"
    - rm -rf microservice-manifest-repo
    - git clone https://oauth2:${GITLAB_TOKEN}@gitlab.com/public-project8832250/microservice-manifest-repo.git  
    - cd microservice-manifest-repo/k8s-manifests
    - yq eval ".spec.template.spec.containers[0].image = \"$IMAGES_NAME:$IMAGE_TAG\"" -i user-deploy-svc.yml
    - git config user.email "ci@gitlab.com"
    - git config user.name "GitLab CI"
    - git add user-deploy-svc.yml
    - git commit -m "Update user service image to $IMAGE_TAG"
    - git push origin main